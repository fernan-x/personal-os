generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String?
  name        String?
  isActive    Boolean  @default(false)
  ssoProvider String?
  ssoId       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  habits      Habit[]

  budgetMemberships BudgetMembership[]
  incomes           Income[]
  plannedExpenses   PlannedExpense[]
  expenseShares     ExpenseShare[]
  envelopeEntries   EnvelopeEntry[]

  householdMemberships HouseholdMember[]
  activityLogs         ActivityLog[]        @relation("ActivityLogUser")
  checklistCompleted   DailyChecklistItem[] @relation("ChecklistCompletedBy")
  dashboardWidgets     DashboardWidget[]

  recipes          Recipe[]
  recipeFavorites  RecipeFavorite[]
  mealPlans        MealPlan[]

  @@unique([ssoProvider, ssoId])
  @@map("users")
}

enum HabitFrequency {
  daily
  weekly
  custom
}

model Habit {
  id          String         @id @default(cuid())
  name        String
  description String?
  frequency   HabitFrequency @default(daily)
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  userId      String?
  user        User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  entries     HabitEntry[]

  @@index([userId])
  @@map("habits")
}

model HabitEntry {
  id        String   @id @default(cuid())
  habitId   String
  date      DateTime @db.Date
  completed Boolean  @default(false)
  note      String?
  createdAt DateTime @default(now())
  habit     Habit    @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([habitId, date])
  @@map("habit_entries")
}

// ── Budget ──────────────────────────────────────────────────────

model BudgetGroup {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members BudgetMembership[]
  plans   MonthlyPlan[]

  @@map("budget_groups")
}

model BudgetMembership {
  id        String   @id @default(cuid())
  userId    String
  groupId   String
  createdAt DateTime @default(now())

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  group BudgetGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([groupId])
  @@map("budget_memberships")
}

model MonthlyPlan {
  id        String   @id @default(cuid())
  groupId   String
  month     Int
  year      Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group     BudgetGroup      @relation(fields: [groupId], references: [id], onDelete: Cascade)
  incomes   Income[]
  expenses  PlannedExpense[]
  envelopes Envelope[]

  @@unique([groupId, month, year])
  @@map("monthly_plans")
}

enum ExpenseScope {
  personal
  common
}

enum ExpenseRecurrence {
  recurring
  exceptional
}

enum ExpenseStatus {
  pending
  paid
}

model Income {
  id            String   @id @default(cuid())
  monthlyPlanId String
  userId        String
  source        String
  amount        Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  monthlyPlan MonthlyPlan @relation(fields: [monthlyPlanId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([monthlyPlanId])
  @@map("incomes")
}

model PlannedExpense {
  id            String            @id @default(cuid())
  monthlyPlanId String
  userId        String?
  name          String
  amount        Int
  scope         ExpenseScope      @default(personal)
  recurrence    ExpenseRecurrence @default(recurring)
  status        ExpenseStatus     @default(pending)
  categoryId    String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  monthlyPlan MonthlyPlan      @relation(fields: [monthlyPlanId], references: [id], onDelete: Cascade)
  user        User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  category    ExpenseCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  shares      ExpenseShare[]

  @@index([monthlyPlanId])
  @@map("planned_expenses")
}

model ExpenseShare {
  id               String @id @default(cuid())
  plannedExpenseId String
  userId           String
  percentage       Int

  plannedExpense PlannedExpense @relation(fields: [plannedExpenseId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([plannedExpenseId, userId])
  @@map("expense_shares")
}

model ExpenseCategory {
  id        String  @id @default(cuid())
  name      String  @unique
  icon      String?
  isDefault Boolean @default(false)

  expenses  PlannedExpense[]
  envelopes Envelope[]

  @@map("expense_categories")
}

model Envelope {
  id              String   @id @default(cuid())
  monthlyPlanId   String
  categoryId      String
  allocatedAmount Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  monthlyPlan MonthlyPlan     @relation(fields: [monthlyPlanId], references: [id], onDelete: Cascade)
  category    ExpenseCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  entries     EnvelopeEntry[]

  @@unique([monthlyPlanId, categoryId])
  @@map("envelopes")
}

model EnvelopeEntry {
  id         String   @id @default(cuid())
  envelopeId String
  userId     String
  amount     Int
  note       String?
  date       DateTime @db.Date
  createdAt  DateTime @default(now())

  envelope Envelope @relation(fields: [envelopeId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([envelopeId])
  @@map("envelope_entries")
}

// ── Puppy Tracker ───────────────────────────────────────────────

enum ActivityType {
  meal
  walk
  potty
  sleep
  grooming
  medication
  other
}

enum TrainingStatus {
  not_started
  in_progress
  learned
}

enum MedicationFrequency {
  once_daily
  twice_daily
  three_times_daily
  weekly
  as_needed
}

model Household {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members HouseholdMember[]
  pets    Pet[]

  @@map("households")
}

model HouseholdMember {
  id          String   @id @default(cuid())
  userId      String
  householdId String
  createdAt   DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  @@unique([userId, householdId])
  @@index([householdId])
  @@map("household_members")
}

model Pet {
  id          String    @id @default(cuid())
  householdId String
  name        String
  breed       String?
  birthDate   DateTime? @db.Date
  photoUrl    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  household          Household           @relation(fields: [householdId], references: [id], onDelete: Cascade)
  routineTemplates   RoutineTemplate[]
  dailyChecklistItems DailyChecklistItem[]
  activityLogs       ActivityLog[]
  weightEntries      WeightEntry[]
  vetVisits          VetVisit[]
  vaccinations       Vaccination[]
  medications        Medication[]
  trainingMilestones TrainingMilestone[]

  @@index([householdId])
  @@map("pets")
}

model RoutineTemplate {
  id        String       @id @default(cuid())
  petId     String
  name      String
  time      String
  type      ActivityType
  sortOrder Int          @default(0)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  pet            Pet                  @relation(fields: [petId], references: [id], onDelete: Cascade)
  checklistItems DailyChecklistItem[]

  @@index([petId])
  @@map("routine_templates")
}

model DailyChecklistItem {
  id            String    @id @default(cuid())
  petId         String
  templateId    String
  date          DateTime  @db.Date
  completed     Boolean   @default(false)
  completedById String?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())

  pet         Pet              @relation(fields: [petId], references: [id], onDelete: Cascade)
  template    RoutineTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  completedBy User?            @relation("ChecklistCompletedBy", fields: [completedById], references: [id], onDelete: SetNull)

  @@unique([templateId, date])
  @@index([petId])
  @@map("daily_checklist_items")
}

model ActivityLog {
  id       String       @id @default(cuid())
  petId    String
  userId   String
  type     ActivityType
  duration Int?
  note     String?
  loggedAt DateTime     @default(now())

  pet  Pet  @relation(fields: [petId], references: [id], onDelete: Cascade)
  user User @relation("ActivityLogUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@index([userId])
  @@map("activity_logs")
}

model WeightEntry {
  id        String   @id @default(cuid())
  petId     String
  weight    Int
  date      DateTime @db.Date
  createdAt DateTime @default(now())

  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@unique([petId, date])
  @@map("weight_entries")
}

model VetVisit {
  id            String    @id @default(cuid())
  petId         String
  date          DateTime  @db.Date
  reason        String
  notes         String?
  nextVisitDate DateTime? @db.Date
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@map("vet_visits")
}

model Vaccination {
  id          String    @id @default(cuid())
  petId       String
  name        String
  date        DateTime  @db.Date
  nextDueDate DateTime? @db.Date
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@map("vaccinations")
}

model Medication {
  id        String              @id @default(cuid())
  petId     String
  name      String
  dosage    String
  frequency MedicationFrequency
  startDate DateTime            @db.Date
  endDate   DateTime?           @db.Date
  notes     String?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@map("medications")
}

model TrainingMilestone {
  id           String         @id @default(cuid())
  petId        String
  command      String
  status       TrainingStatus @default(not_started)
  dateAchieved DateTime?      @db.Date
  notes        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@map("training_milestones")
}

// ── Dashboard ──────────────────────────────────────────────────

model DashboardWidget {
  id        String   @id @default(cuid())
  userId    String
  type      String
  position  Int
  config    Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("dashboard_widgets")
}

// ── Meal Planner ──────────────────────────────────────────────

enum RecipeVisibility {
  public
  private
}

enum RecipeDifficulty {
  easy
  medium
  hard
}

enum MealSlot {
  breakfast
  lunch
  dinner
  snack
}

enum IngredientUnit {
  g
  kg
  ml
  l
  piece
  tbsp
  tsp
  cup
  pinch
}

model RecipeTag {
  id        String          @id @default(cuid())
  name      String          @unique
  createdAt DateTime        @default(now())
  recipes   RecipeTagLink[]

  @@map("recipe_tags")
}

model Recipe {
  id          String           @id @default(cuid())
  userId      String
  title       String
  description String?
  photoUrl    String?
  sourceUrl   String?
  visibility  RecipeVisibility @default(private)
  difficulty  RecipeDifficulty @default(medium)
  prepTime    Int?
  cookTime    Int?
  servings    Int              @default(4)
  calories    Int?
  protein     Int?
  carbs       Int?
  fat         Int?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  ingredients     RecipeIngredient[]
  instructions    RecipeInstruction[]
  tags            RecipeTagLink[]
  favorites       RecipeFavorite[]
  mealPlanEntries MealPlanEntry[]

  @@index([userId])
  @@index([visibility])
  @@map("recipes")
}

model RecipeIngredient {
  id        String         @id @default(cuid())
  recipeId  String
  name      String
  quantity  Float
  unit      IngredientUnit @default(g)
  sortOrder Int            @default(0)

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("recipe_ingredients")
}

model RecipeInstruction {
  id         String @id @default(cuid())
  recipeId   String
  stepNumber Int
  content    String

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([recipeId, stepNumber])
  @@index([recipeId])
  @@map("recipe_instructions")
}

model RecipeTagLink {
  id       String @id @default(cuid())
  recipeId String
  tagId    String

  recipe Recipe    @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  tag    RecipeTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([recipeId, tagId])
  @@map("recipe_tag_links")
}

model RecipeFavorite {
  id        String   @id @default(cuid())
  userId    String
  recipeId  String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@map("recipe_favorites")
}

model MealPlan {
  id        String   @id @default(cuid())
  userId    String
  name      String
  startDate DateTime @db.Date
  endDate   DateTime @db.Date
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  entries MealPlanEntry[]

  @@index([userId])
  @@map("meal_plans")
}

model MealPlanEntry {
  id         String   @id @default(cuid())
  mealPlanId String
  recipeId   String
  date       DateTime @db.Date
  slot       MealSlot
  servings   Int      @default(2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  mealPlan MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  recipe   Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([mealPlanId])
  @@map("meal_plan_entries")
}
